{% extends "core/base.html" %}

{% load static %}

{% block title %}{{ post.title }} | Blog{% endblock %}

{% block extra_head %}
<style>
body {
    background-color: #F9FAFC;
}

.brand {
    font-family: Lato, sans-serif;
    font-size: 1.4rem;
    font-weight: 700;
    color: #4A4A4F;
}

.red-o {
    color: #E84610;
}

.thin {
    font-weight: 300;
}

.light-bg {
    background-color: #fff;
}

.dark-bg {
    background-color: #445261;
}

.main-bg {
    background-color: #F9FAFC;
}

.card {
    border: none;
    background-color: transparent;
}

.image-container {
    position: relative;
}

.image-flash {
    position: absolute;
    bottom: 5%;
    min-width: 30%;
    left: -2px;
    background-color: #188181;
}

.scale {
    width: 100%;
    height: auto;
}

.author {
    color: white;
    margin: 4px;
    text-transform: uppercase;
}

.masthead {
    margin-top: 10px;
    overflow: hidden;
    position: relative;
    display: inline-block;
    height: 33vh;
    width: 100%;
}

.masthead-text {
    background-color: #445261;
    color: white;
    position: relative;
}

.masthead-image {
    position: relative;
    overflow: hidden;
}

.masthead-image:after {
    content: "";
    position: absolute;
    top: 0;
    right: 90%;
    height: 100%;
    width: 150%;
    background: #445261;
    -webkit-transform: skew(15deg);
    -moz-transform: skew(15deg);
    transform: skew(15deg);
    z-index: 100;
}

.post-link {
    text-decoration: none;
    color: #445261;
}

.post-link:hover,
.page-link {
    color: #E84610;
}

.post-title {
    margin-top: 10%;
    margin-left: 5%;
}

.post-subtitle {
    margin-left: 5%;
    color: lightgray;
}

.btn-signup,
.btn-edit {
    background-color: #188181;
    color: #fff;
}

.btn-signup:hover,
.btn-signup:active {
    background-color: #fff;
    color: #23BBBB;
}

.link {
    color: #23BBBB;
    text-decoration: none;
}

.link:hover,
.link:active {
    color: #445261;
    text-decoration: underline;
}

.btn-like {
    color: #E84610;
    border: none;
    background: transparent;
}

.btn-delete {
    color: #fff;
    background: #E84610;
}

.btn-like:hover,
.btn-like:active {
    color: #E84610;
    background: transparent;
    border: none;
}

.faded {
    color: rgb(172, 175, 175);
}

.approval {
    color: rgb(222, 146, 168);
}

/* Comments specific */
.comments .card {
    background: #fff;
}

.comments .card-body {
    padding: 1rem;
}

.comments .font-weight-bold {
    font-weight: 700;
}

/* make sure images and layout collapse nicely on small screens */
@media (max-width: 767.98px) {
    .post-content img { max-width: 100%; height: auto; }
    .comments .card { margin-bottom: 1rem; }
}
</style>
{% endblock %}

{% block content %}
<section class="container section my-4">
    <div class="row">
        <div class="col-12">
            <article>
                <h1>{{ post.title }}</h1>
                <p class="text-muted">By {{ post.author.get_full_name|default:post.author.username }} â€” {{ post.created_on|date:"F j, Y" }}</p>

                {% comment %}Treat Cloudinary placeholder as missing{% endcomment %}
                {% if post.featured_image and 'placeholder' not in post.featured_image.url %}
                    <img src="{{ post.featured_image.url }}" alt="{{ post.title }}" class="img-fluid mb-3" loading="lazy" data-default-src="{% static 'core/images/users/default.jpg' %}" onerror="this.onerror=null;this.src=this.dataset.defaultSrc;"/>
                {% else %}
                    <img src="{% static 'core/images/users/default.jpg' %}" alt="{{ post.title }}" class="img-fluid mb-3" loading="lazy"/>
                {% endif %}

                <div class="post-content">
                    {{ post.content|safe }}
                </div>

                <p class="mt-4"><a href="{% url 'blog_home' %}" class="btn btn-secondary">Back to Blog</a></p>
            </article>
        </div>
    </div>
</section>
<!-- Comments Section -->
<section id="comments" class="container mt-4">
    <div class="row">
        <div class="col-12">
            <strong class="text-secondary"><i class="far fa-comments"></i> {{ comments.count }}</strong>
            <hr>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8 card mb-4 mt-3 comments">
            <h3>Comments:</h3>
            <div class="card-body">
                {% for comment in comments %}
                <div class="p-2 comments {% if not comment.approved %}faded{% endif %}">
                    <p class="font-weight-bold">
                        {% if comment.author %}{{ comment.author.get_full_name|default:comment.author.username }}{% else %}{{ comment.name|default:"Guest" }}{% endif %}
                        <span class="font-weight-normal">{{ comment.created_at|date:"F j, Y, g:i a" }}</span> wrote:
                    </p>
                    <div id="comment{{ comment.pk }}">
                        <p>{{ comment.content }}</p>
                    </div>

                    {# approval notice removed: do not show "awaiting approval" text #}

                    <div class="mt-2">
                        {% if user.is_staff or user.is_authenticated and comment.author == user %}
                            <button class="btn btn-delete" comment_id="{{ comment.pk }}" data-delete-url="{% url 'comment_delete' post.slug comment.pk %}">Delete</button>
                            <button class="btn btn-edit" type="button" data-edit-url="{% url 'comment_edit' post.slug comment.pk %}" data-comment-pk="{{ comment.pk }}" onclick="startEdit('{{ comment.pk }}', this.getAttribute('data-edit-url'))">Edit</button>
                        {% elif not user.is_authenticated and guest_session_id and comment.session_id == guest_session_id %}
                            <button class="btn btn-delete" comment_id="{{ comment.pk }}" data-delete-url="{% url 'comment_delete' post.slug comment.pk %}">Delete</button>
                            <button class="btn btn-edit" type="button" data-edit-url="{% url 'comment_edit' post.slug comment.pk %}" data-comment-pk="{{ comment.pk }}" onclick="startEdit('{{ comment.pk }}', this.getAttribute('data-edit-url'))">Edit</button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Creating New Comments -->
        <div class="col-md-4 card mb-4 mt-3">
            <div class="card-body">
                <h3>Leave a comment:</h3>
                <form id="commentForm" method="post" style="margin-top:1.3em;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add_comment">
                    <input type="hidden" name="anon_session_id" id="anon_session_id" value="">

                    {% if user.is_authenticated %}
                        <p>Posting as: {{ user.get_full_name|default:user.username }}</p>
                    {% else %}
                        <p>Posting as: <strong>Anonymous</strong></p>
                        <div class="mb-3">
                            <label for="id_name" class="form-label">Name (optional)</label>
                            <input id="id_name" name="name" class="form-control" maxlength="100" />
                        </div>
                        <div class="mb-3">
                            <label for="id_email" class="form-label">Email (optional)</label>
                            <input id="id_email" name="email" type="email" class="form-control" />
                        </div>
                    {% endif %}

                    <div id="div_id_body" class="mb-3">
                        <label for="id_body" class="form-label requiredField">Body<span class="asteriskField">*</span></label>
                        <textarea id="id_body" name="content" cols="40" rows="6" class="textarea form-control" required></textarea>
                    </div>
                    <button id="submitButton" type="submit" class="btn btn-signup btn-lg">Submit</button>
                </form>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function(){

    // Start editing a comment by populating the main comment textarea and
    // switching the comment form to submit to the comment edit URL.
    var _originalFormAction = null;
    var _originalActionValue = null;
    var _originalSubmitText = null;
    var editingPk = null;

    function startEdit(pk, editUrl){
        var commentDiv = document.getElementById('comment'+pk);
        var form = document.getElementById('commentForm');
        var textarea = document.getElementById('id_body');
        var actionInput = form.querySelector('[name=action]');
        var submitBtn = document.getElementById('submitButton');
        if(!form || !textarea || !submitBtn) return;

        // Save originals once
        if(_originalFormAction === null) _originalFormAction = form.action || '';
        if(_originalActionValue === null) _originalActionValue = (actionInput && actionInput.value) ? actionInput.value : '';
        if(_originalSubmitText === null) _originalSubmitText = submitBtn.textContent;

        // Populate textarea with comment text (use innerText to avoid HTML)
        if(commentDiv){ textarea.value = commentDiv.innerText.trim(); }

        // Point the main form at the edit URL so submission goes to comment_edit view
        // Defensive: ensure we don't accidentally assign a DOM element (or other
        // non-string) to `form.action` which would coerce to "[object HTMLInputElement]"
        // and produce incorrect request URLs. Accept either a string URL or an
        // element that contains a `data-edit-url` attribute.
        try{
            var safeUrl = null;
            if(typeof editUrl === 'string'){
                safeUrl = editUrl;
            }else if(editUrl && typeof editUrl.getAttribute === 'function'){
                safeUrl = editUrl.getAttribute('data-edit-url') || '';
            }else if(editUrl && editUrl.href){
                safeUrl = editUrl.href;
            }else{
                // fallback: coerce to string but guard against '[object HTMLInputElement]'
                safeUrl = String(editUrl || '');
            }
            if(safeUrl){ form.action = safeUrl; }
        }catch(e){ /* ignore and leave original form.action intact */ }
        if(actionInput){ actionInput.value = 'edit'; }

        submitBtn.textContent = 'Update';
        textarea.focus();
        editingPk = pk;
        // scroll the comment form into view for convenience
        try{ textarea.scrollIntoView({behavior: 'smooth', block: 'center'}); }catch(e){}
    }
    window.startEdit = startEdit;

    // Capture delete button clicks (used by modal logic elsewhere)
    var deleteButtons = document.querySelectorAll('.btn-delete');
    deleteButtons.forEach(function(btn){
        btn.addEventListener('click', function(e){
            // data-delete-url is handled by the site-wide delete modal code
            // in the base template; nothing else needed here.
        });
    });

    // Populate anon_session_id hidden input from window.siteSessionId if available
    try{
        var anonField = document.getElementById('anon_session_id');
        var sessId = (typeof window.siteSessionId !== 'undefined' && window.siteSessionId) ? window.siteSessionId : null;
        if(!sessId){
            try{
                var raw = localStorage.getItem('site_session');
                var parsed = raw ? JSON.parse(raw) : null;
                if(parsed && parsed.id) sessId = parsed.id;
            }catch(e){}
        }
        if(anonField && sessId){
            anonField.value = sessId;
        }
        var commentFormEl = document.getElementById('commentForm');
        if(commentFormEl){
            commentFormEl.addEventListener('submit', function(){
                try{ if(anonField && !anonField.value){ anonField.value = sessId || (JSON.parse(localStorage.getItem('site_session')||'null')||{}).id || ''; } }catch(e){}
            });
        }
    }catch(e){}

    {% if user.is_authenticated %}
    // Intercept comment form submit for authenticated users and POST via fetch.
    // If the server returns rendered HTML (for auto-approved users), insert it.
    (function(){
        var form = document.getElementById('commentForm');
        if(!form) return;
            form.addEventListener('submit', function(e){
                        // If currently editing a comment, show the site-styled confirmation
                        // modal and submit normally on confirm so the server-side
                        // `comment_edit` view performs the update and redirects.
                        if(editingPk){
                            e.preventDefault();
                            // Use the shared site action modal exposed by base template.
                            if(window.showSiteActionModal){
                                window.showSiteActionModal({
                                    title: 'Update comment?',
                                    body: 'Apply your changes to this comment? Your edit will be saved, and may require admin approval.',
                                    confirmText: 'Update',
                                    onConfirm: function(){
                                        // submit the main comment form normally
                                        var f = document.getElementById('commentForm');
                                        if(f) f.submit();
                                    }
                                });
                                return;
                            }
                            // fallback to native confirm
                            var ok = window.confirm('Apply update to this comment?');
                            if(ok){ form.submit(); }
                            return;
                        }

                // Only intercept if adding a new comment (not editing)
                e.preventDefault();
                var fd = new FormData(form);
                var csrftokenEl = document.querySelector('[name=csrfmiddlewaretoken]');
                var csrftoken = csrftokenEl ? csrftokenEl.value : '';
                // Post to the form's action (which may have been changed for editing)
                var target = form.action || location.href;
                // Defensive validation: if `target` looks like a coerced DOM string
                // such as "[object HTMLInputElement]" or is not a plausible URL,
                // fall back to the current location so we don't POST to an invalid path.
                try{
                    var isString = (typeof target === 'string');
                    var containsObject = isString && target.indexOf('[object') !== -1;
                    var looksLikeUrl = isString && (target.indexOf('/') === 0 || /^https?:\/\//.test(target));
                    if(containsObject || !looksLikeUrl){
                        console.warn('Comment form action invalid, falling back to current location:', target);
                        target = location.href;
                        // also repair the form.action so subsequent submits use a good value
                        try{ form.action = target; }catch(e){}
                    }
                }catch(e){ target = location.href; }

                fetch(target, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrftoken
                    },
                    body: fd,
                    credentials: 'same-origin'
                }).then(function(resp){
                    return resp.text().catch(function(){ return null; });
                }).then(function(html){
                    if(html){
                        var commentsBody = document.querySelector('.comments .card-body');
                        if(commentsBody){
                            var wrapper = document.createElement('div');
                            wrapper.innerHTML = html;
                            var newNode = wrapper.firstElementChild;
                            if(newNode) commentsBody.insertBefore(newNode, commentsBody.firstElementChild);
                            // clear textarea
                            var ta = form.querySelector('textarea[name=content]'); if(ta) ta.value = '';
                            // restore form action and submit text after successful insert
                            if(_originalFormAction !== null){ form.action = _originalFormAction; }
                            var actionInput2 = form.querySelector('[name=action]'); if(actionInput2) actionInput2.value = _originalActionValue || 'add_comment';
                            var submitBtn2 = document.getElementById('submitButton'); if(submitBtn2) submitBtn2.textContent = _originalSubmitText || 'Submit';
                            editingPk = null;
                            return;
                        }
                    }
                    // Fallback: perform full-page navigation to handle redirects or non-HTML responses
                    window.location = location.href;
                }).catch(function(){ window.location = location.href; });
            });
    })();
    {% endif %}

});
</script>

{% endblock %}

<!-- Site-styled edit confirmation modal (used when user presses Update while editing) -->
<div id="siteEditModal" class="site-modal" aria-hidden="true">
    <div class="site-modal-overlay"></div>
    <div class="site-modal-dialog">
        <div class="site-modal-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Update comment?</h5>
            <button type="button" class="site-modal-close btn btn-sm btn-close btn-close-white" aria-label="Close"></button>
        </div>
        <div class="site-modal-body">
            <p>Apply your changes to this comment? Your edit will be saved, and may require admin approval.</p>
        </div>
        <div class="site-modal-footer text-end">
            <button type="button" class="btn btn-secondary site-edit-cancel">Close</button>
            <button id="siteEditConfirm" type="button" class="btn btn-danger">Update</button>
        </div>
    </div>
</div>

<script>
// Wire the site-styled edit modal so it can be shown when editing and will
// submit the main comment form on confirm.
(function(){
    var siteModal = document.getElementById('siteEditModal');
    if(!siteModal) return;
    var siteConfirm = document.getElementById('siteEditConfirm');
    var siteCancelBtns = document.querySelectorAll('.site-edit-cancel, .site-modal-close');
    var siteOverlay = siteModal.querySelector('.site-modal-overlay');

    function show(){
        siteModal.classList.add('open');
        siteModal.setAttribute('aria-hidden','false');
    }
    function hide(){
        siteModal.classList.remove('open');
        siteModal.setAttribute('aria-hidden','true');
    }

    window.showSiteEditModal = show;

    if(siteConfirm){
        siteConfirm.addEventListener('click', function(){
            // submit the main comment form normally so Django handles the POST
            var form = document.getElementById('commentForm');
            hide();
            if(form) form.submit();
        });
    }

    siteCancelBtns.forEach(function(btn){ btn.addEventListener('click', hide); });
    if(siteOverlay) siteOverlay.addEventListener('click', hide);
})();
</script>

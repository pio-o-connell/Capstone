{% extends "core/base.html" %}

{% load static %}

{% block title %}{{ post.title }} | Blog{% endblock %}

{% block extra_head %}
<style>
body {
    background-color: #F9FAFC;
}

.brand {
    font-family: Lato, sans-serif;
    font-size: 1.4rem;
    font-weight: 700;
    color: #4A4A4F;
}

.red-o {
    color: #E84610;
}

.thin {
    font-weight: 300;
}

.light-bg {
    background-color: #fff;
}

.dark-bg {
    background-color: #445261;
}

.main-bg {
    background-color: #F9FAFC;
}

.card {
    border: none;
    background-color: transparent;
}

.image-container {
    position: relative;
}

.image-flash {
    position: absolute;
    bottom: 5%;
    min-width: 30%;
    left: -2px;
    background-color: #188181;
}

.scale {
    width: 100%;
    height: auto;
}

.author {
    color: white;
    margin: 4px;
    text-transform: uppercase;
}

.masthead {
    margin-top: 10px;
    overflow: hidden;
    position: relative;
    display: inline-block;
    height: 33vh;
    width: 100%;
}

.masthead-text {
    background-color: #445261;
    color: white;
    position: relative;
}

.masthead-image {
    position: relative;
    overflow: hidden;
}

.masthead-image:after {
    content: "";
    position: absolute;
    top: 0;
    right: 90%;
    height: 100%;
    width: 150%;
    background: #445261;
    -webkit-transform: skew(15deg);
    -moz-transform: skew(15deg);
    transform: skew(15deg);
    z-index: 100;
}

.post-link {
    text-decoration: none;
    color: #445261;
}

.post-link:hover,
.page-link {
    color: #E84610;
}

.post-title {
    margin-top: 10%;
    margin-left: 5%;
}

.post-subtitle {
    margin-left: 5%;
    color: lightgray;
}

.btn-signup,
.btn-edit {
    background-color: #188181;
    color: #fff;
}

.btn-signup:hover,
.btn-signup:active {
    background-color: #fff;
    color: #23BBBB;
}

.link {
    color: #23BBBB;
    text-decoration: none;
}

.link:hover,
.link:active {
    color: #445261;
    text-decoration: underline;
}

.btn-like {
    color: #E84610;
    border: none;
    background: transparent;
}

.btn-delete {
    color: #fff;
    background: #E84610;
}

.btn-like:hover,
.btn-like:active {
    color: #E84610;
    background: transparent;
    border: none;
}

.faded {
    color: rgb(172, 175, 175);
}

.approval {
    color: rgb(222, 146, 168);
}

/* Comments specific */
.comments .card {
    background: #fff;
}

.comments .card-body {
    padding: 1rem;
}

.comments .font-weight-bold {
    font-weight: 700;
}

/* make sure images and layout collapse nicely on small screens */
@media (max-width: 767.98px) {
    .post-content img { max-width: 100%; height: auto; }
    .comments .card { margin-bottom: 1rem; }
}
</style>
{% endblock %}

{% block content %}
<section class="container section my-4">
    <div class="row">
        <div class="col-12">
            <article>
                <h1>{{ post.title }}</h1>
                <p class="text-muted">By {{ post.author.get_full_name|default:post.author.username }} â€” {{ post.created_on|date:"F j, Y" }}</p>

                {% comment %}Treat Cloudinary placeholder as missing{% endcomment %}
                {% if post.featured_image and 'placeholder' not in post.featured_image.url %}
                    <img src="{{ post.featured_image.url }}" alt="{{ post.title }}" class="img-fluid mb-3" loading="lazy" data-default-src="{% static 'core/images/users/default.jpg' %}" onerror="this.onerror=null;this.src=this.dataset.defaultSrc;"/>
                {% else %}
                    <img src="{% static 'core/images/users/default.jpg' %}" alt="{{ post.title }}" class="img-fluid mb-3" loading="lazy"/>
                {% endif %}

                <div class="post-content">
                    {{ post.content|safe }}
                </div>

                <p class="mt-4"><a href="{% url 'blog_home' %}" class="btn btn-secondary">Back to Blog</a></p>
            </article>
        </div>
    </div>
</section>
<!-- Comments Section -->
<section id="comments" class="container mt-4">
    <div class="row">
        <div class="col-12">
            <strong class="text-secondary"><i class="far fa-comments"></i> {{ comments.count }}</strong>
            <hr>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8 card mb-4 mt-3 comments">
            <h3>Comments:</h3>
            <div class="card-body">
                {% for comment in comments %}
                <div class="p-2 comments {% if not comment.approved %}faded{% endif %}">
                    <p class="font-weight-bold">
                        {% if comment.author %}{{ comment.author.get_full_name|default:comment.author.username }}{% else %}{{ comment.name|default:"Guest" }}{% endif %}
                        <span class="font-weight-normal">{{ comment.created_at|date:"F j, Y, g:i a" }}</span> wrote:
                    </p>
                    <div id="comment{{ comment.pk }}">
                        <p>{{ comment.content }}</p>
                    </div>

                    {% if not comment.approved %}
                        <p class="approval">This comment is awaiting approval</p>
                    {% endif %}

                    <div class="mt-2">
                        {% if user.is_authenticated and comment.author == user %}
                            <button class="btn btn-delete" comment_id="{{ comment.pk }}" data-bs-toggle="modal" data-bs-target="#deleteModal">Delete</button>
                            <button class="btn btn-edit" comment_id="{{ comment.pk }}" type="button" onclick="toggleEdit('{{ comment.pk }}');">Edit</button>

                            <form id="edit-form-{{ comment.pk }}" method="post" action="{% url 'comment_edit' post.slug comment.pk %}" style="display:none; margin-top:0.75rem;">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <textarea name="content" class="form-control" rows="3">{{ comment.content }}</textarea>
                                </div>
                                <button class="btn btn-signup btn-sm" type="submit">Save</button>
                                <button class="btn btn-secondary btn-sm" type="button" onclick="toggleEdit('{{ comment.pk }}');">Cancel</button>
                            </form>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Creating New Comments -->
        <div class="col-md-4 card mb-4 mt-3">
            <div class="card-body">
                <h3>Leave a comment:</h3>
                <form id="commentForm" method="post" style="margin-top:1.3em;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add_comment">
                    <input type="hidden" name="anon_session_id" id="anon_session_id" value="">

                    {% if user.is_authenticated %}
                        <p>Posting as: {{ user.get_full_name|default:user.username }}</p>
                    {% else %}
                        <p>Posting as: <strong>Anonymous</strong></p>
                        <div class="mb-3">
                            <label for="id_name" class="form-label">Name (optional)</label>
                            <input id="id_name" name="name" class="form-control" maxlength="100" />
                        </div>
                        <div class="mb-3">
                            <label for="id_email" class="form-label">Email (optional)</label>
                            <input id="id_email" name="email" type="email" class="form-control" />
                        </div>
                    {% endif %}

                    <div id="div_id_body" class="mb-3">
                        <label for="id_body" class="form-label requiredField">Body<span class="asteriskField">*</span></label>
                        <textarea id="id_body" name="content" cols="40" rows="6" class="textarea form-control" required></textarea>
                    </div>
                    <button id="submitButton" type="submit" class="btn btn-signup btn-lg">Submit</button>
                </form>
            </div>
        </div>
    </div>
</section>

<!-- Delete confirmation modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Delete comment?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">Are you sure you want to delete your comment? This action cannot be undone.</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button id="deleteConfirm" type="button" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden delete form (submitted by modal) -->
<form id="delete-form-generic" method="post" style="display:none;">
    {% csrf_token %}
</form>

<script>
function toggleEdit(pk){
    var f = document.getElementById('edit-form-'+pk);
    if(!f) return;
    f.style.display = (f.style.display === 'none' || f.style.display === '') ? 'block' : 'none';
}
// Delete modal handling: set target URL on confirm
document.addEventListener('DOMContentLoaded', function(){
    var deleteButtons = document.querySelectorAll('.btn-delete');
    var activeCommentId = null;
    deleteButtons.forEach(function(btn){
        btn.addEventListener('click', function(e){
            activeCommentId = btn.getAttribute('comment_id') || btn.getAttribute('data-comment-id');
        });
    });

    // Populate anon_session_id hidden input from window.siteSessionId if available
    try{
        var anonField = document.getElementById('anon_session_id');
        // prefer the helper exposed by base template
        var sessId = (typeof window.siteSessionId !== 'undefined' && window.siteSessionId) ? window.siteSessionId : null;
        // fallback: try reading localStorage directly (in case base script didn't expose window.siteSessionId)
        if(!sessId){
            try{
                var raw = localStorage.getItem('site_session');
                var parsed = raw ? JSON.parse(raw) : null;
                if(parsed && parsed.id) sessId = parsed.id;
            }catch(e){}
        }
        if(anonField && sessId){
            anonField.value = sessId;
        }
        // ensure field is populated at submit time as a final fallback
        var commentFormEl = document.getElementById('commentForm');
        if(commentFormEl){
            commentFormEl.addEventListener('submit', function(){
                try{ if(anonField && !anonField.value){ anonField.value = sessId || (JSON.parse(localStorage.getItem('site_session')||'null')||{}).id || ''; } }catch(e){}
            });
        }
    }catch(e){}

    var deleteConfirm = document.getElementById('deleteConfirm');
    deleteConfirm.addEventListener('click', function(){
        if(!activeCommentId) return;
        // build action URL for delete endpoint - use pattern and replace last segment
        var pattern = "{% url 'comment_delete' post.slug 0 %}"; // e.g. /blog/slug/comment/0/delete/
        var action = pattern.replace('/0/delete/', '/' + activeCommentId + '/delete/');
        var form = document.getElementById('delete-form-generic');
        form.action = action;
        form.submit();
    });
});

{% endblock %}
